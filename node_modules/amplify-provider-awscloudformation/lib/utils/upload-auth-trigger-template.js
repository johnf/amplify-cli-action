"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.uploadAuthTriggerTemplate = exports.AUTH_TRIGGER_STACK = exports.AUTH_TRIGGER_TEMPLATE = void 0;
const amplify_cli_core_1 = require("amplify-cli-core");
const path_1 = __importDefault(require("path"));
const push_resources_1 = require("../push-resources");
const constants_1 = require("../constants");
exports.AUTH_TRIGGER_TEMPLATE = 'auth-trigger-cloudformation-template.json';
exports.AUTH_TRIGGER_STACK = 'AuthTriggerCustomLambdaStack';
const S3_UPLOAD_PATH = `auth/${exports.AUTH_TRIGGER_TEMPLATE}`;
async function uploadAuthTriggerTemplate(context) {
    var _a, _b, _c, _d;
    if (!amplify_cli_core_1.FeatureFlags.getBoolean('auth.breakCircularDependency')) {
        return {};
    }
    const category = 'auth';
    let { amplifyMeta } = context.amplify.getProjectDetails();
    const authResource = (_a = amplifyMeta === null || amplifyMeta === void 0 ? void 0 : amplifyMeta.auth) !== null && _a !== void 0 ? _a : {};
    const authResourceParams = Object.keys(authResource);
    if (authResourceParams.length === 0) {
        return {};
    }
    const resourceDir = path_1.default.join(amplify_cli_core_1.pathManager.getBackendDirPath(), category, authResourceParams[0]);
    const authTriggerCfnFilePath = path_1.default.join(resourceDir, exports.AUTH_TRIGGER_TEMPLATE);
    const { DeploymentBucketName } = (_d = (_c = (_b = context.amplify.getProjectMeta()) === null || _b === void 0 ? void 0 : _b.providers) === null || _c === void 0 ? void 0 : _c[constants_1.ProviderName]) !== null && _d !== void 0 ? _d : {};
    try {
        amplify_cli_core_1.JSONUtilities.readJson(authTriggerCfnFilePath);
    }
    catch (err) {
        return {
            AuthTriggerTemplateURL: '',
        };
    }
    await push_resources_1.uploadTemplateToS3(context, path_1.default.join(resourceDir, exports.AUTH_TRIGGER_TEMPLATE), category, '', null);
    return {
        AuthTriggerTemplateURL: `https://s3.amazonaws.com/${DeploymentBucketName}/amplify-cfn-templates/${S3_UPLOAD_PATH}`,
    };
}
exports.uploadAuthTriggerTemplate = uploadAuthTriggerTemplate;
//# sourceMappingURL=upload-auth-trigger-template.js.map